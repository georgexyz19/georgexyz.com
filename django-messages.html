<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="/theme/css/bs4min.css">
    <link rel="shortcut icon" type="image/x-icon" href="/theme/images/favicon.ico" >
    <link rel="icon" type="image/x-icon" href="/theme/images/favicon.ico" >
<link rel="stylesheet" href="/theme/css/friendly.css">
<link rel="stylesheet" href="/theme/css/custom.css">
<meta name="author" content="George Zhang" />
<meta name="keywords" content="django" />
<meta name="description" content="Django messages app is used to “display one-time notification message to the user after processing a form or some other types of user input.” Django official documentation has a page …" />
    <title>Django Messages Contrib App - George Zhang</title>
  </head>
  <body>
    <!-- navbar -->
    <nav class="navbar navbar-expand-md navbar-light" style="background-color: #e3f2fd;">
      <div class="container">
        <a class="navbar-brand" href="/">George Zhang</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarColor01" aria-controls="navbarColor01" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarColor01">
          <ul class="navbar-nav mr-auto">
            <li class="nav-item">
              <a class="nav-link " 
                href="/articlelist.html">Articles</a>
            </li>
            <li class="nav-item">
              <a class="nav-link pr-3 " 
                href="/tags.html">Tags</a>
            </li>
            <li class="nav-item">
              <a class="nav-link pr-3 "
                 href="/pages/inkscape-tutorial.html">Inkscape Tutorial</a>
            </li>
            <li class="nav-item">
                <a class="nav-link "
                   href="/pages/projects.html">Projects</a>
              </li>
          </ul>

          <ul class="navbar-nav">
            <li class="nav-item">
              <a class="nav-link " 
                 href="/pages/about.html">About</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

   

<div class="container">

  <div class="row">
    <div class="col-lg-8 mx-auto">

      <h2>Django Messages Contrib App</h2>

      <div class="text-muted mb-2">
        <span>Posted on </span>
        <time datetime="2019-07-15 11:25:00-04:00">
          Monday, 07/15/2019 11:25
        </time>

        <span>with tags: </span>
        <a href="/tag/django.html">django</a>
      </div>

      <p>Django messages app is used to &#8220;display one-time notification message to the 
user after processing a form or some other types of user input.&#8221; Django 
official documentation has a page 
<a href="https://docs.djangoproject.com/en/2.2/ref/contrib/messages/">the messages framework</a> 
for the app. </p>
<h3>How to Use Messages App</h3>
<p>Chapter 11 of <em>Django Unleashed</em> book utilizes the app to convey a message 
that an email has been successfully sent. The code is easy to understand. 
The view adds a success message to the message queue. The next web page 
(redirected page <code>blog_post_list</code>) will show the message.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># contact/views.py</span>

<span class="o">...</span>
<span class="kn">from</span> <span class="nn">django.contrib.messages</span> <span class="kn">import</span> <span class="n">success</span>

<span class="k">class</span> <span class="nc">ContactView</span><span class="p">(</span><span class="n">View</span><span class="p">):</span>
    <span class="o">....</span>

    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">bound_form</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_class</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">bound_form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">mail_sent</span> <span class="o">=</span> <span class="n">bound_form</span><span class="o">.</span><span class="n">send_email</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">mail_sent</span><span class="p">:</span>
                <span class="n">success</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Email successfully sent.&#39;</span><span class="p">)</span>  <span class="c1"># &lt;------</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;blog_post_list&#39;</span><span class="p">)</span>             <span class="c1"># &lt;------</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_name</span><span class="p">,</span> 
                      <span class="p">{</span><span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">bound_form</span> <span class="p">}</span> <span class="p">)</span>
</code></pre></div>

<p>The code to show the messages is in the base.html file, and all web pages 
extended from the base.html will show the messages. </p>
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
  {% for message in messages %}
    {% if message.tags %}
    <span class="p">&lt;</span><span class="nt">li</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;{{ message.tags }}&quot;</span><span class="p">&gt;</span>
    {% else %}
    <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span>
    {% endif %}
    {{ message }}<span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
  {% endfor %}
<span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
</code></pre></div>

<p>The code above is very similar to the code shown on the Django official 
documentation page (shown below). </p>
<div class="highlight"><pre><span></span><code>{% if messages %}
&lt;ul class=&quot;messages&quot;&gt;
    {% for message in messages %}
    &lt;li{% if message.tags %} class=&quot;{{ message.tags }}&quot;{% endif %}&gt;
      {{ message }}&lt;/li&gt;
    {% endfor %}
&lt;/ul&gt;
{% endif %}
</code></pre></div>

<h3>Source Code Files</h3>
<p>The source code for the messages app is in the django/contrib/messages directory. 
It consists of 13 python files, and the total line count is 647 in Django 2.2.2.</p>
<div class="highlight"><pre><span></span><code>george@STK2M3:~$ find . -name <span class="s1">&#39;*.py&#39;</span> -exec wc -l <span class="o">{}</span> +
   <span class="m">26</span> ./middleware.py
    <span class="m">4</span> ./__init__.py
   <span class="m">21</span> ./constants.py
   <span class="m">96</span> ./api.py
   <span class="m">18</span> ./views.py
   <span class="m">13</span> ./context_processors.py
   <span class="m">12</span> ./utils.py
    <span class="m">7</span> ./apps.py
  <span class="m">170</span> ./storage/base.py       <span class="c1">#  &lt;----- backend storage</span>
   <span class="m">12</span> ./storage/__init__.py
   <span class="m">48</span> ./storage/session.py
  <span class="m">166</span> ./storage/cookie.py
   <span class="m">54</span> ./storage/fallback.py
  <span class="m">647</span> total
</code></pre></div>

<h3>Messages App <span class="caps">API</span></h3>
<p>The __init__.py file imports all from api.py and constants.py. The api.py 
file defines the <span class="caps">API</span> of the messages app, which includes those functions:</p>
<ul>
<li>add_message</li>
<li>get_message</li>
<li>get_level</li>
<li>set_level</li>
<li>debug, info, warning, success, and error (call add_message)</li>
</ul>
<p>The functions shows that the attribute <code>_message</code> of request is the message 
storage.</p>
<p>The constants.py defines a few constants:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># messages/constants.py</span>

<span class="n">DEBUG</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">INFO</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">SUCCESS</span> <span class="o">=</span> <span class="mi">25</span>
<span class="n">WARNING</span> <span class="o">=</span> <span class="mi">30</span>
<span class="n">ERROR</span> <span class="o">=</span> <span class="mi">40</span>

<span class="n">DEFAULT_TAGS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">DEBUG</span><span class="p">:</span> <span class="s1">&#39;debug&#39;</span><span class="p">,</span>
    <span class="n">INFO</span><span class="p">:</span> <span class="s1">&#39;info&#39;</span><span class="p">,</span>
    <span class="n">SUCCESS</span><span class="p">:</span> <span class="s1">&#39;success&#39;</span><span class="p">,</span>
    <span class="n">WARNING</span><span class="p">:</span> <span class="s1">&#39;warning&#39;</span><span class="p">,</span>
    <span class="n">ERROR</span><span class="p">:</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">DEFAULT_LEVELS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;DEBUG&#39;</span><span class="p">:</span> <span class="n">DEBUG</span><span class="p">,</span>
    <span class="s1">&#39;INFO&#39;</span><span class="p">:</span> <span class="n">INFO</span><span class="p">,</span>
    <span class="s1">&#39;SUCCESS&#39;</span><span class="p">:</span> <span class="n">SUCCESS</span><span class="p">,</span>
    <span class="s1">&#39;WARNING&#39;</span><span class="p">:</span> <span class="n">WARNING</span><span class="p">,</span>
    <span class="s1">&#39;ERROR&#39;</span><span class="p">:</span> <span class="n">ERROR</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>

<p>The middleware.py code is an good example of how to write a middleware for 
Django. The class derives from MiddlewareMixin and defines two methods 
<code>process_request</code> and <code>process_response</code>.  The <code>process_request</code> adds 
<code>_messages</code> attribute to the request and <code>process_response</code> stores the messages 
by calling <code>update</code> method of <code>_message</code> and raises an exception if messages 
are not all stored.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># messages/middleware.py</span>

<span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">django.contrib.messages.storage</span> <span class="kn">import</span> <span class="n">default_storage</span>
<span class="kn">from</span> <span class="nn">django.utils.deprecation</span> <span class="kn">import</span> <span class="n">MiddlewareMixin</span>


<span class="k">class</span> <span class="nc">MessageMiddleware</span><span class="p">(</span><span class="n">MiddlewareMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Middleware that handles temporary messages.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">process_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">request</span><span class="o">.</span><span class="n">_messages</span> <span class="o">=</span> <span class="n">default_storage</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">process_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the storage backend (i.e., save the messages).</span>

<span class="sd">        Raise ValueError if not all messages could be stored and DEBUG is True.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># A higher middleware layer may return a request which does not contain</span>
        <span class="c1"># messages storage, so make no assumption that it will be there.</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;_messages&#39;</span><span class="p">):</span>
            <span class="n">unstored_messages</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">_messages</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">unstored_messages</span> <span class="ow">and</span> <span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Not all temporary messages could be stored.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span>
</code></pre></div>

<p>The context_processor.py defines a function <code>messages</code> which simply returns a 
dictionary of two context variables.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># messages/context_processor.py </span>

<span class="kn">from</span> <span class="nn">django.contrib.messages.api</span> <span class="kn">import</span> <span class="n">get_messages</span>
<span class="kn">from</span> <span class="nn">django.contrib.messages.constants</span> <span class="kn">import</span> <span class="n">DEFAULT_LEVELS</span>


<span class="k">def</span> <span class="nf">messages</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a lazy &#39;messages&#39; context variable as well as</span>
<span class="sd">    &#39;DEFAULT_MESSAGE_LEVELS&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;messages&#39;</span><span class="p">:</span> <span class="n">get_messages</span><span class="p">(</span><span class="n">request</span><span class="p">),</span>
        <span class="s1">&#39;DEFAULT_MESSAGE_LEVELS&#39;</span><span class="p">:</span> <span class="n">DEFAULT_LEVELS</span><span class="p">,</span>
    <span class="p">}</span>
</code></pre></div>

<p>The <code>views.py</code> defines a SuccessMessageMixin, which adds a success message 
attribute to class based views. It is probably easier for a programmer 
to call <code>success</code> <span class="caps">API</span> method directly to add a message. </p>
<p>The <code>utils.py</code> file defines a <code>get_level_tags</code> function which returns a 
dictionary of level tags. </p>
<h3>Messages Backend Storage</h3>
<p>The interesting part of the messages app is its storage. The __init__.py in 
the storage defines a <code>default_storage</code> function. </p>
<div class="highlight"><pre><span></span><code><span class="c1"># messages/storage/__init__.py</span>

<span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">django.utils.module_loading</span> <span class="kn">import</span> <span class="n">import_string</span>


<span class="k">def</span> <span class="nf">default_storage</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Callable with the same interface as the storage classes.</span>

<span class="sd">    This isn&#39;t just default_storage = import_string(settings.MESSAGE_STORAGE)</span>
<span class="sd">    to avoid accessing the settings at the module level.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">import_string</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">MESSAGE_STORAGE</span><span class="p">)(</span><span class="n">request</span><span class="p">)</span>
</code></pre></div>

<p>The grep command results show that <code>MESSAGE_STORAGE</code> is assigned FallBackStorage 
class which is defined in the fallback.py file. </p>
<div class="highlight"><pre><span></span><code>george@STK2M3:~/Desktop/django-2.2.2$ grep -nr &#39;MESSAGE_STORAGE&#39; ./
./django/contrib/messages/storage/__init__.py:9: 
   This isn&#39;t just default_storage = import_string(settings.MESSAGE_STORAGE)
./django/contrib/messages/storage/__init__.py:12: 
   return import_string(settings.MESSAGE_STORAGE)(request)
./django/conf/global_settings.py:554:MESSAGE_STORAGE = 
   &#39;django.contrib.messages.storage.fallback.FallbackStorage&#39;
</code></pre></div>

<p>The <code>import_string</code> function is defined in the module_loading.py file, which 
&#8220;imports a dotted module path and return the attribute/class designated by the 
last name in the path.&#8221;</p>
<p>The base.py file defines Message class, which has three attributes: 
level, message, and extra_tags. It also defines BaseStorage class, 
which is an abstraction of messages storage.  Two methods of the class <code>_get</code> 
and <code>_store</code> are placeholders and they must be overridden. </p>
<p>To understand code in the BaseStorage class, we need to think about 
how an object of Message class is instantiated, stored, and retrieved. Here are 
the steps in which methods in BaseStorage are called. </p>
<ol>
<li>A request comes to Django. Messages middleware initializes a default_storage
   backend and assigns it to the <code>_messages</code> attribute of request.</li>
<li>The <code>add_message</code> method of message <span class="caps">API</span> is called. It calls the add method in 
   BaseStorage, which changes <code>added_new</code> attribute to <code>True</code> and append the 
   message into the <code>_queued_messages</code> list. </li>
<li>If the view function does not call the template render function, the 
   <code>__iter__</code> method of BaseStorage is not called.</li>
<li>The <code>process_response</code> method of middleware class calls <code>update</code> method of 
   BaseStorage, which stores unread messages. Let&#8217;s assume messages are saved 
   in a cookie (session works in a similar way). They are stored in client&#8217;s 
   browser storage, not on the server. </li>
<li>A new request comes in, Django does the same as step 1.</li>
<li>The view function calls the template <code>render</code> method, which calls the 
   <code>__iter__</code> method of BaseStorage.  It changes <code>used</code> attribute to <code>True</code>. 
   The <code>_queued_messages</code> is empty at this time, and it is not the 
   same object described in step 2. It then calls <code>_loaded_messages</code> property 
   and calls <code>_get</code> method to retrieve the stored message. All cookies from 
   this domain will be uploaded to the server. </li>
<li>The <code>process_response</code> method of middleware class calls <code>update</code> method 
   of BaseStorage. In this case the <code>_queued_messages</code> list is empty, and 
   nothing is stored. </li>
</ol>
<p>The logic in the <code>update</code> method of BaseStorage is smart. If two consecutive 
requests add two messages without displaying them, both messages will be 
stored. Here is the source code. </p>
<div class="highlight"><pre><span></span><code><span class="c1"># update method of BaseStorage class</span>
<span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Store all unread messages.</span>

<span class="sd">    If the backend has yet to be iterated, store previously stored messages</span>
<span class="sd">    again. Otherwise, only store messages added after the last iteration.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_messages</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_queued_messages</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">used</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_queued_messages</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>  <span class="c1"># normally empty</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">added_new</span><span class="p">:</span>
        <span class="n">messages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loaded_messages</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_queued_messages</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>
</code></pre></div>

<h3>Cookies and Sessions</h3>
<p>The discussion of the messages app has already became convoluted, and it will 
become even more complicated when we examine how cookies and sessions work. 
I will have a general dicussion on cookies and sessions and stop here.  It will 
be in another post to have a detailed discussion of those topics. Tango with 
Django book has 
<a href="https://www.tangowithdjango.com/book17/chapters/cookie.html">a chapter on cookies and sessions</a> 
which is very good. </p>
<p>Internet cookies is &#8220;a small piece of data sent from a web server and stored 
on the user&#8217;s computer&#8221;.  The 
<a href="https://en.wikipedia.org/wiki/HTTP_cookie">wikipedia http cookie page</a> 
provides a good overview of the topic. The cookie information is sent via the 
http header, which usually has a size limit. The session cookie 
contains a unique session id, and the infomation is saved in server database. 
Django web framework also comes with a sessions contrib app.  Here is the link 
to the 
<a href="https://docs.djangoproject.com/en/2.2/topics/http/sessions/">official documentation</a>. </p>
<p>The SessionStorage class does not need to consider the size limit when saving 
messages, so the code is simpler than in CookieStorage class.  Here is the 
source code of session.py file. </p>
<div class="highlight"><pre><span></span><code><span class="c1"># messages/storage/session.py</span>
<span class="kn">import</span> <span class="nn">json</span>

<span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">django.contrib.messages.storage.base</span> <span class="kn">import</span> <span class="n">BaseStorage</span>
<span class="kn">from</span> <span class="nn">django.contrib.messages.storage.cookie</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">MessageDecoder</span><span class="p">,</span> <span class="n">MessageEncoder</span><span class="p">,</span>
<span class="p">)</span>


<span class="k">class</span> <span class="nc">SessionStorage</span><span class="p">(</span><span class="n">BaseStorage</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Store messages in the session (that is, django.contrib.sessions).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">session_key</span> <span class="o">=</span> <span class="s1">&#39;_messages&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;session&#39;</span><span class="p">),</span> <span class="s2">&quot;The session-based temporary &quot;</span>\
            <span class="s2">&quot;message storage requires session middleware to be installed, &quot;</span>\
            <span class="s2">&quot;and come before the message middleware in the &quot;</span>\
            <span class="s2">&quot;MIDDLEWARE</span><span class="si">%s</span><span class="s2"> list.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s2">&quot;_CLASSES&quot;</span> <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">MIDDLEWARE</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve a list of messages from the request&#39;s session. This storage</span>
<span class="sd">        always stores everything it is given, so return True for the</span>
<span class="sd">        all_retrieved flag.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">deserialize_messages</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session_key</span><span class="p">)),</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_store</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Store a list of messages to the request&#39;s session.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">messages</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">session_key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">serialize_messages</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session_key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">serialize_messages</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">):</span>
        <span class="n">encoder</span> <span class="o">=</span> <span class="n">MessageEncoder</span><span class="p">(</span><span class="n">separators</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">encoder</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">deserialize_messages</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">data</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="n">MessageDecoder</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span>
</code></pre></div>

<h3>Conclusion</h3>
<p>The messages app is easy to use in a Django app, but the implementation of 
the app is not simple.  Reading the source code helps us understand how the 
Django messages app works.   </p>



    </div>
  </div>

</div>

   
    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
  </body>
</html>