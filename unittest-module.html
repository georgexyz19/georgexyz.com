<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="/theme/css/bs4min.css">
    <link rel="shortcut icon" type="image/x-icon" href="/theme/images/favicon.ico" >
    <link rel="icon" type="image/x-icon" href="/theme/images/favicon.ico" >
<link rel="stylesheet" href="https://www.georgexyz.com/theme/css/friendly.css">
<link rel="stylesheet" href="https://www.georgexyz.com/theme/css/custom.css">
<meta name="author" content="George Zhang" />
<meta name="keywords" content="python" />
<meta name="description" content="Unit test is one of the Python techniques I want to learn for quite some time. This post records some articles I read and some notes I wrote in the â€¦" />
    <title>Unittest Module - George Zhang</title>
  </head>
  <body>
    <!-- navbar -->
    <nav class="navbar navbar-expand-md navbar-light" style="background-color: #e3f2fd;">
      <div class="container">
        <a class="navbar-brand" href="/">George Zhang</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarColor01" aria-controls="navbarColor01" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarColor01">
          <ul class="navbar-nav mr-auto">
            <li class="nav-item">
              <a class="nav-link " 
                href="/articlelist.html">Articles</a>
            </li>
            <li class="nav-item">
              <a class="nav-link pr-3 " 
                href="/tags.html">Tags</a>
            </li>
            <li class="nav-item">
                <a class="nav-link "
                   href="/pages/projects.html">Projects</a>
              </li>
          </ul>

          <ul class="navbar-nav">
            <li class="nav-item">
              <a class="nav-link " 
                 href="/pages/about.html">About</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

   

<div class="container">

  <div class="row">
    <div class="col-lg-8 mx-auto">

      <h2>Unittest Module</h2>

      <div class="text-muted mb-2">
        <span>Posted on </span>
        <time datetime="2022-01-22 09:28:00-05:00">
          Saturday, 01/22/2022 09:28
        </time>

        <span>with tags: </span>
        <a href="https://www.georgexyz.com/tag/python.html">python</a>
      </div>

      <p>Unit test is one of the Python techniques I want to learn for quite some time. 
This post records some articles I read and some notes I wrote in the past few days.  </p>
<h3>Links</h3>
<p>There are lots of excellent materials on this topics.  Here are some 
nice articles. </p>
<p>The Python documentation website has an official page for unittest, which 
is a good starting point. </p>
<p><a href="https://docs.python.org/3/library/unittest.html">Unit Testing Framework</a></p>
<p>Ned Batchelder&#8217;s Pycon talk <em>Get Started Testing</em> is excellent. Ned is one of 
the best speakers in Python community.  The two slide pages <em>Under The Covers</em> 
are superb. </p>
<p><a href="https://youtu.be/FxSsnHeWQBY">Getting Started Testing - PyCon 2014 Video</a></p>
<p>Real Python website has an article <em>Getting Started with Testing in Python</em>, 
which is a nice intro article with broad views. </p>
<p><a href="https://realpython.com/python-testing/">Getting Started With Testing in Python</a></p>
<p>The articles I spent most of my time on are two articles by Miguel Grinberg, 
who is one of my favorite authors. He recently posts three articles on 
testing.  Here are the links, </p>
<p><a href="https://blog.miguelgrinberg.com/post/how-to-write-unit-tests-in-python-part-1-fizz-buzz">How to Write Unit Tests in Python, Part 1: Fizz Buzz</a></p>
<p><a href="https://blog.miguelgrinberg.com/post/how-to-write-unit-tests-in-python-part-2-game-of-life">How to Write Unit Tests in Python, Part 2: Game of Life</a></p>
<p><a href="https://blog.miguelgrinberg.com/post/how-to-write-unit-tests-in-python-part-3-web-applications">How to Write Unit Tests in Python, Part 3: Web Applications</a></p>
<p>I haven&#8217;t read the third article yet, but the first two are classics 
in my view. </p>
<p>There are many other Pycon talks and articles in Python testing.  I will gradually 
add links to them when I have more time to study. </p>
<h3>Source Code</h3>
<p>This article will only discuss the <em>unittest</em> module code.  I am concentrating 
on the standard Python modules now. </p>
<p>The source code is in this directory.  </p>
<div class="highlight"><pre><span></span><code>~/.pyenv/versions/3.9.7/lib/python3.9/unittest
</code></pre></div>

<p>The source code directory includes a <code>test</code> subdirectory which has files 
that test the unittest code. If we do not consider code in this directory, 
here is the statistics of the unittest code base. </p>
<div class="highlight"><pre><span></span><code>$ find . -maxdepth 1 -name &#39;*.py&#39; -exec wc -l &#39;{}&#39; + | sort -n
    18 ./__main__.py
    69 ./_log.py
    71 ./signals.py
    95 ./__init__.py
   160 ./async_case.py
   170 ./util.py
   216 ./result.py
   221 ./runner.py
   275 ./main.py
   379 ./suite.py
   517 ./loader.py
  1435 ./case.py
  2891 ./mock.py
  6517 total
</code></pre></div>

<p>It has thirteen files and the total line count is 6,517. The <code>mock.py</code> 
module alone has 2,891 lines of code, which is more than a third of 
total lines. </p>
<h3>Test Example</h3>
<p>Let&#8217;s create two simple functions and write some test code.  The <code>mysum.py</code> 
has two functions and the <code>test_mysum.py</code> file has code testing the functions. </p>
<div class="highlight"><pre><span></span><code>#  mysum.py 

def sum(arg):
    total = 0
    for val in arg:
        total += val
    return total

def add(a, b):
    return a + b
</code></pre></div>

<p>I copied the <code>unittest</code> directory to the project directory and renamed it 
to be <code>myunittest</code>. So I can change the source code and add logging 
statements without modifying the standard library code.  </p>
<div class="highlight"><pre><span></span><code># test_mysum.py

import myunittest as unittest
from mysum import sum, add

class TestSum(unittest.TestCase):

    def test_sum(self):
        self.assertEqual(sum([1, 2, 3]), 6, &quot;Should be 6&quot;)

    def test_sum_tuple(self):
        self.assertEqual(sum((1, 2, 2)), 5, &quot;Should be 6&quot;)


class TestAdd(unittest.TestCase):
    def test_add(self):
        self.assertEqual(add(1, 2), 3, &quot;should be 3&quot;)


if __name__ == &#39;__main__&#39;:
    unittest.main()
</code></pre></div>

<h4>Main Function Call</h4>
<p>The <code>main</code> part of the <code>unittest.main()</code> function call is actually a class 
<code>TestProgram</code> in <code>main.py</code>.  The <code>unittest.main()</code> function call actually 
invokes the <code>__init__</code> method of the class.  The <code>__init__</code> method sets 
some instance variables and invokes two methods <code>parseArgs</code> and 
<code>runTests</code>. </p>
<p>Let&#8217;s look at the <code>runTests</code> method first.  If we ignore exception handling 
code, the method looks like this,</p>
<div class="highlight"><pre><span></span><code># concept code
self.testRunner = runner.TextTestRunner
testRunner = self.testRunner(verbosity=self.verbosity, ... )
self.result = testRunner.run(self.test)
</code></pre></div>

<p>The <code>runTests</code> method initialize a <code>TextTestRunner</code> object, and calls the 
<code>run</code> method of the class.  The return value is assigned to the <code>result</code> 
instance variable. </p>
<h4>Load Tests</h4>
<p>The <code>self.test</code> argument in the last line of the code is a <code>TestSuite</code> object. 
The instance variable is set in the <code>createTests</code> method.  The <code>parseArgs</code> 
method sets up arguments and calls the <code>createTests</code> method as its last line. 
The <code>createTests</code> method mainly calls this method.</p>
<div class="highlight"><pre><span></span><code>self.test = self.testLoader.loadTestsFromModule(self.module)  # load tests
</code></pre></div>

<p>The <code>self.testLoader</code> itself is <code>loader.defaultTestLoader</code> object, which is 
an instance of <code>TestLoader</code> class.  The above statement calls the 
<code>loadTestsFromModule</code> method of <code>TestLoader</code> class and saves its 
return value in the <code>self.test</code> instance variable. The <code>loadTestsFromModule</code> 
method looks like this,</p>
<div class="highlight"><pre><span></span><code># concept code
def loadTestsFromModule(self, module, ...):
    ...
    tests = []
    for name in dir(module):
        obj = getattr(module, name)
        if isinstance(obj, type) and issubclass(obj, case.TestCase):
            tests.append(self.loadTestsFromTestCase(obj))
    tests = self.suiteClass(tests)
    ...
    return tests
</code></pre></div>

<p>The <code>self.suiteClass</code> is referring to <code>suite.TestSuite</code> class. The 
<code>loadTestsFromModule</code> creates a list and passes the list to the 
<code>TestSuite</code> class. The method returns an <code>TestSuite</code> class instance. 
The instance is in this form if we print it out in console. </p>
<div class="highlight"><pre><span></span><code>&lt;myunittest.suite.TestSuite tests= 
    [&lt;myunittest.suite.TestSuite 
         tests=[&lt;__main__.TestAdd testMethod=test_add&gt;]&gt;, 
     &lt;myunittest.suite.TestSuite 
         tests=[&lt;__main__.TestSum testMethod=test_sum&gt;, 
                &lt;__main__.TestSum testMethod=test_sum_tuple&gt;]&gt;
    ]
&gt;
</code></pre></div>

<p>The code in the <code>loadTestsFromTestCase</code> method is shown below. </p>
<div class="highlight"><pre><span></span><code>def loadTestsFromTestCase(self, testCaseClass):
    ...
    testCaseNames = self.getTestCaseNames(testCaseClass)
    if not testCaseNames and hasattr(testCaseClass, &#39;runTest&#39;):
        testCaseNames = [&#39;runTest&#39;]
    loaded_suite = self.suiteClass(map(testCaseClass, testCaseNames))
    return loaded_suite
</code></pre></div>

<p>The <code>loaded_suite = self.suiteClass(map(...))</code> line is a little strange. 
The <code>testCaseClass</code> is one of the two classes <code>TestSum</code> and <code>TestAdd</code>, and 
both are derived from <code>TestCase</code>.  The <code>testCaseNames</code> are the method 
names defined in the classes like <code>test_sum</code>, <code>test_sum_tuple</code>, and 
<code>test_add</code>. The <code>testCaseNames</code> is a list.  The <code>map</code> function turns 
out to call the <code>__init__</code> method of <code>TestCase</code>, which is defined in the 
<code>case.py</code> module. </p>
<h4>Run Tests</h4>
<p>Let&#8217;s go back to the <code>self.result = testRunner.run(self.test)</code> line 
of code and what  the <code>run</code> is doing.  The method invoked the 
method <code>run</code> in the <code>TextTestRunner</code> class. The method looks like 
this, </p>
<div class="highlight"><pre><span></span><code>def run(self, test):
    result = self._makeResult()
    ...
    test(result)
    ...
    return result
</code></pre></div>

<p>The <code>test</code> argument is the <code>TestSuite</code> object return by the <code>loadTestsFromModule</code> 
method. The run method above calls the <code>__call__</code> method of the <code>TestSuite</code> object, 
which in turn calls the <code>run</code> method of <code>TestSuite</code>.  The <code>run</code> method of <code>TestSuite</code> 
class is very interesting, and it is recursive.  The code looks like this, </p>
<div class="highlight"><pre><span></span><code># concept code
def run(self, result, ...):
    ...
    for index, test in enumerate(self):
        ...
        test(result)
    ...
    return result
</code></pre></div>

<p>The <code>run</code> method of <code>TestSuite</code> class will invoke the <code>run</code> method of <code>TestCase</code> 
class during the recursive call.  The <code>run</code> method of <code>TestCase</code> code looks 
like this, </p>
<div class="highlight"><pre><span></span><code>def run(self, result=None):
    ...
    result.startTest(self)

    try:
        ...
        outcome = _Outcome(result)
        try:
            self._outcome = outcome

            with outcome.testPartExecutor(self):
                self.setUp()
            if outcome.success:
                outcome.expecting_failure = expecting_failure
                with outcome.testPartExecutor(self, isTest=True):
                    testMethod()
                outcome.expecting_failure = False
                with outcome.testPartExecutor(self):
                    self.tearDown()

            self.doCleanups()
            ....
</code></pre></div>

<p>The <code>testPartExecutor</code> is a context manager defined in the <code>_Outcome</code> class. 
It catches most exceptions.  The code is shown below. </p>
<div class="highlight"><pre><span></span><code># testPartExecutor method in _Outcome

@contextlib.contextmanager
def testPartExecutor(self, test_case, isTest=False):
    old_success = self.success
    self.success = True
    try:
        yield
    except KeyboardInterrupt:
        raise
    except SkipTest as e:
        self.success = False
        self.skipped.append((test_case, str(e)))
    except _ShouldStop:
        pass
    except:
        exc_info = sys.exc_info()
        if self.expecting_failure:
            self.expectedFailure = exc_info
        else:
            self.success = False
            self.errors.append((test_case, exc_info))
        # explicitly break a reference cycle:
        # exc_info -&gt; frame -&gt; exc_info
        exc_info = None
    else:
        if self.result_supports_subtests and self.success:
            self.errors.append((test_case, None))
    finally:
        self.success = self.success and old_success
</code></pre></div>

<p>The source code becomes quite complicated at this stage. But this is 
essentially how the unittest module works. </p>
<h3>Next Steps</h3>
<p>I actually have two Python testing books which I haven&#8217;t started 
reading. Also I need to add some unittest code to my own projects. </p>



    </div>
  </div>

</div>

   
    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
  </body>
</html>