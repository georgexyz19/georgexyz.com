<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous"> -->
    <link rel="stylesheet" href="/theme/css/bs4min.css">
    <link rel="shortcut icon" type="image/x-icon" href="https://www.georgexyz.com/theme/images/favicon.ico" >
    <link rel="icon" type="image/x-icon" href="https://www.georgexyz.com/theme/images/favicon.ico" >
 
    <link rel="stylesheet" href="https://www.georgexyz.com/theme/css/friendly.css">
    <link rel="stylesheet" href="https://www.georgexyz.com/theme/css/custom.css">
    <meta name="author" content="George Zhang" />
    <meta name="keywords" content="python,pelican" />
    <meta name="description" content="Articles on this website before this one are all written in markdown format. I want to write some articles in reStructuredText (rst) format but the default docutils tool that comes …" />
    <title>Pelican Source Code and Plugin - George Zhang</title>
  </head>
  <body>
    <!-- navbar -->
    <nav class="navbar navbar-expand-md navbar-light" style="background-color: #e3f2fd;">
      <div class="container">
        <a class="navbar-brand" href="/">George Zhang</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarColor01" aria-controls="navbarColor01" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarColor01">
          <ul class="navbar-nav mr-auto">
            <li class="nav-item">
              <a class="nav-link " 
                href="/articlelist.html">Articles</a>
            </li>
            <li class="nav-item">
              <a class="nav-link pr-3 " 
                href="/tags.html">Tags</a>
            </li>
            <li class="nav-item">
              <a class="nav-link pr-3 "
                 href="/pages/inkscape-tutorial.html">Inkscape Tutorial</a>
            </li>
            <li class="nav-item">
                <a class="nav-link "
                   href="/pages/projects.html">Projects</a>
              </li>
          </ul>

          <ul class="navbar-nav">
            <li class="nav-item">
              <a class="nav-link " 
                 href="/pages/about.html">About</a>
            </li>
          </ul>
        </div>

      </div>
    </nav>

   
  
<div class="container">

  <div class="row">
    <div class="col-lg-8 mx-auto">   

  <h2>Pelican Source Code and&nbsp;Plugin</h2>
  
  <div class="text-muted mb-2">
    <span>Posted on </span>
    <time datetime="2020-04-19 22:08:00-04:00">
      Sunday, 04/19/2020 22:08
    </time>
    
     <span>with tags: </span>
       <a href="https://www.georgexyz.com/tag/python.html">python</a>
/       <a href="https://www.georgexyz.com/tag/pelican.html">pelican</a>
  </div>
      
  <p>Articles on this website before this one are all written in markdown format. I want to
write some articles in reStructuredText (rst) format but the default <code>docutils</code> tool
that comes with Pelican has a flaw causing me to stay away from the rst&nbsp;format.</p>
<p>The problem is that the top title of an aritle (e.g. &#8220;Pelican Source Code and Plugin&#8221;
on this page) is rendered as <code>h2</code> html tag, and section title (e.g. &#8220;Pelican Plugin&#8221;
section below) starts with <code>h3</code> tag. It is designed this way since the start of the website.
In a markdown file, I can add two <code>#</code> to specify a title as <code>h2</code>.  There is
no easy way to specify the heading levels in rst&nbsp;files.</p>
<p>The same problem is described in this <a class="reference external" href="https://github.com/github/markup/issues/567">question</a> on&nbsp;github.</p>
<div class="section" id="pelican-plugin">
<h3>Pelican&nbsp;Plugin</h3>
<p>When I am reading Pelican source code, I find that the Pelican class in the
<code>__init__.py</code> file has an <code>init_plugins</code> method. This method calls each plugin&#8217;s
register function as shown&nbsp;below.</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">init_plugins</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">plugins</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="o">......</span>
    <span class="k">for</span> <span class="n">plugin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;PLUGINS&#39;</span><span class="p">]:</span>
        <span class="o">.....</span>
        <span class="n">plugin</span><span class="o">.</span><span class="n">register</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plugins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plugin</span><span class="p">)</span>
</pre></div>
<p>The Pelican plugin page has an existing plugin <code>headerid</code> which implements a similar
function.  It adds anchor tags to headings in rst&nbsp;files.</p>
</div>
<div class="section" id="override-docutils-method">
<h3>Override Docutils&nbsp;Method</h3>
<p>Google searching class names
in the <code>headerid</code> plugin lead me to a very nice article
<a class="reference external" href="https://www.devdungeon.com/content/restructuredtext-rst-tutorial-0">reStructureText(<span class="caps">RST</span>) Tutorial</a>.
This article discusses the exact same heading problem I have with the rst format and
has code examples on how to solve it.  It becomes easy for me to modify the code in
this article to a Pelican plugin which is very similar to <code>headerid</code>.  I name this new
Pelican plugin <code>headinglower</code> which lowers the heading levels in rst&nbsp;files.</p>
<div class="section" id="headinglower-code">
<h4>Headinglower&nbsp;Code</h4>
<p>The <code>headinglower</code> plugin has two files. The <code>__init__.py</code> file only has one line of&nbsp;code.</p>
<div class="highlight"><pre><span></span><span class="c1"># __init__.py</span>
<span class="kn">from</span> <span class="nn">.headinglower</span> <span class="kn">import</span> <span class="o">*</span>
</pre></div>
<p>The <code>headinglower.py</code> file has the following&nbsp;code.</p>
<div class="highlight"><pre><span></span><span class="c1"># headinglower.py</span>
<span class="kn">from</span> <span class="nn">pelican</span> <span class="kn">import</span> <span class="n">readers</span><span class="p">,</span> <span class="n">logger</span>
<span class="kn">from</span> <span class="nn">pelican.readers</span> <span class="kn">import</span> <span class="n">PelicanHTMLTranslator</span>
<span class="kn">from</span> <span class="nn">pelican</span> <span class="kn">import</span> <span class="n">signals</span>
<span class="kn">from</span> <span class="nn">docutils</span> <span class="kn">import</span> <span class="n">nodes</span>

<span class="k">def</span> <span class="nf">init_headinglower</span><span class="p">(</span><span class="n">sender</span><span class="p">):</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Init Headinglower Plugin&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">register</span><span class="p">():</span>
    <span class="n">signals</span><span class="o">.</span><span class="n">initialized</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">init_headinglower</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">ModPelicanHTMLTranslator</span><span class="p">(</span><span class="n">PelicanHTMLTranslator</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">visit_title</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Only 6 section levels are supported by HTML.&quot;&quot;&quot;</span>
            <span class="n">close_tag</span> <span class="o">=</span> <span class="s1">&#39;&lt;/p&gt;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">topic</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">starttag</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">CLASS</span><span class="o">=</span><span class="s1">&#39;topic-title&#39;</span><span class="p">))</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">sidebar</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">starttag</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">CLASS</span><span class="o">=</span><span class="s1">&#39;sidebar-title&#39;</span><span class="p">))</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Admonition</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">starttag</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">CLASS</span><span class="o">=</span><span class="s1">&#39;admonition-title&#39;</span><span class="p">))</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">table</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">starttag</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;caption&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
                <span class="n">close_tag</span> <span class="o">=</span> <span class="s1">&#39;&lt;/caption&gt;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">document</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">starttag</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;h1&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">CLASS</span><span class="o">=</span><span class="s1">&#39;title&#39;</span><span class="p">))</span>
                <span class="n">close_tag</span> <span class="o">=</span> <span class="s1">&#39;&lt;/h1&gt;</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">in_document_title</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">section</span><span class="p">)</span>
                <span class="c1">## revise here, comment out ( - 1 )</span>
                <span class="n">h_level</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">section_level</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_header_level</span> <span class="c1"># - 1</span>
                <span class="n">atts</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="ow">and</span>
                    <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">parent</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">nodes</span><span class="o">.</span><span class="n">subtitle</span><span class="p">)):</span>
                    <span class="n">atts</span><span class="p">[</span><span class="s1">&#39;CLASS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;with-subtitle&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">starttag</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;h</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">h_level</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">atts</span><span class="p">))</span>
                <span class="n">atts</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">hasattr</span><span class="p">(</span><span class="s1">&#39;refid&#39;</span><span class="p">):</span>
                    <span class="n">atts</span><span class="p">[</span><span class="s1">&#39;class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;toc-backref&#39;</span>
                    <span class="n">atts</span><span class="p">[</span><span class="s1">&#39;href&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;#&#39;</span> <span class="o">+</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;refid&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">atts</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">starttag</span><span class="p">({},</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">atts</span><span class="p">))</span>
                    <span class="n">close_tag</span> <span class="o">=</span> <span class="s1">&#39;&lt;/a&gt;&lt;/h</span><span class="si">%s</span><span class="s1">&gt;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">h_level</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">close_tag</span> <span class="o">=</span> <span class="s1">&#39;&lt;/h</span><span class="si">%s</span><span class="s1">&gt;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">h_level</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">close_tag</span><span class="p">)</span>

    <span class="n">readers</span><span class="o">.</span><span class="n">PelicanHTMLTranslator</span> <span class="o">=</span> <span class="n">ModPelicanHTMLTranslator</span>
</pre></div>
<p>The code add a method <code>visit_title</code> to the PelicanHTMLTranslator class.  It overrides a method
defined in <code>HTMLTranslator</code> class of docutils.writers._html_base&nbsp;module.</p>
</div>
<div class="section" id="plugin-settings">
<h4>Plugin&nbsp;Settings</h4>
<p>Add the following settings to the <code>pelicanconf.py</code>, the Pelican will automatically load the&nbsp;plugin.</p>
<div class="highlight"><pre><span></span>PLUGIN_PATHS = [&#39;plugin/&#39;, ]
PLUGINS=[&#39;headinglower&#39;,]
</pre></div>
</div>
</div>
<div class="section" id="better-way">
<h3>Better&nbsp;Way</h3>
<p>The above method works well and solves my problem.  But there is a better and easier
way to solve the exact problem.  Pelican has over 100 settings, and one
of them is <code>DOCUTILS_SETTINGS</code>.  It is described on the <a class="reference external" href="https://docs.getpelican.com/en/stable/settings.html">documentation</a> page&nbsp;as:</p>
<blockquote>
Extra configuration settings for the docutils publisher (applicable only to
reStructuredText). See Docutils Configuration settings for more details.</blockquote>
<p>The <code>RstReader</code> class in <code>readers.py</code> file of Pelican source code has a method
<code>_get_publisher</code>. It has the following lines of&nbsp;code.</p>
<div class="highlight"><pre><span></span><span class="n">extra_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;initial_header_level&#39;</span><span class="p">:</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;syntax_highlight&#39;</span><span class="p">:</span> <span class="s1">&#39;short&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;input_encoding&#39;</span><span class="p">:</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;language_code&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_language_code</span><span class="p">,</span>
                    <span class="s1">&#39;halt_level&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                    <span class="s1">&#39;traceback&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="s1">&#39;warning_stream&#39;</span><span class="p">:</span> <span class="n">StringIO</span><span class="p">(),</span>
                    <span class="s1">&#39;embed_stylesheet&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>

<span class="n">user_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;DOCUTILS_SETTINGS&#39;</span><span class="p">)</span>
<span class="k">if</span> <span class="n">user_params</span><span class="p">:</span>
    <span class="n">extra_params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">user_params</span><span class="p">)</span>
</pre></div>
<p>I can simply set the <code>initial_header_level</code> value to 3 and the problem is solved.
Add the following settings in the <code>pelicanconf.py</code>, the first section title heading will
become <code>h3</code>.  Note the article title heading level <code>h2</code> is actually set in the
<code>article.html</code> template file. I also comment out the two plugin settings
shown in the previous&nbsp;section.</p>
<div class="highlight"><pre><span></span>DOCUTILS_SETTINGS = {&#39;initial_header_level&#39;: &#39;3&#39;, }
</pre></div>
<div class="section" id="rst-file-of-this-article">
<h4>Rst File of This&nbsp;Article</h4>
<p>The rst file of this article is available on github. <a class="reference external" href="https://github.com/georgexyz19/georgexyz.com/blob/master/content/posts/pelican-source-code-plugin.rst">Click here</a> to read the source file and click
&#8220;Raw&#8221; button to see the text&nbsp;file.</p>
</div>
</div>


    </div>
  </div>

</div>
  
   

    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>

  </body>
</html>