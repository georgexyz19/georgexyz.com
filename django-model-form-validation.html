<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous"> -->
    <link rel="stylesheet" href="/theme/css/bs4min.css">
    <link rel="shortcut icon" type="image/x-icon" href="/theme/images/favicon.ico" >
    <link rel="icon" type="image/x-icon" href="/theme/images/favicon.ico" >
 
    <link rel="stylesheet" href="/theme/css/friendly.css">
    <link rel="stylesheet" href="/theme/css/custom.css">
    <meta name="author" content="George Zhang" />
    <meta name="keywords" content="django" />
    <meta name="description" content="Django model and form validation is a somewhat complicated and confusing topic in Django app development. A developer needs to understand several basic concepts such as model, model field, form …" />
    <title>Django Model and Form Validation - George Zhang</title>
  </head>
  <body>
    <!-- navbar -->
    <nav class="navbar navbar-expand-md navbar-light" style="background-color: #e3f2fd;">
      <div class="container">
        <a class="navbar-brand" href="/">George Zhang</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarColor01" aria-controls="navbarColor01" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarColor01">
          <ul class="navbar-nav mr-auto">
            <li class="nav-item">
              <a class="nav-link " 
                href="/articlelist.html">Articles</a>
            </li>
            <li class="nav-item">
              <a class="nav-link pr-3 " 
                href="/tags.html">Tags</a>
            </li>
            <li class="nav-item">
              <a class="nav-link pr-3 "
                 href="/pages/inkscape-tutorial.html">Inkscape Tutorial</a>
            </li>
            <li class="nav-item">
                <a class="nav-link "
                   href="/pages/projects.html">Projects</a>
              </li>
          </ul>

          <ul class="navbar-nav">
            <li class="nav-item">
              <a class="nav-link " 
                 href="/pages/about.html">About</a>
            </li>
          </ul>
        </div>

      </div>
    </nav>

   
  
<div class="container">

  <div class="row">
    <div class="col-lg-8 mx-auto">   

  <h2>Django Model and Form&nbsp;Validation</h2>
  
  <div class="text-muted mb-2">
    <span>Posted on </span>
    <time datetime="2019-08-15 00:59:00-04:00">
      Thursday, 08/15/2019 00:59
    </time>
    
     <span>with tags: </span>
       <a href="/tag/django.html">django</a>
  </div>
      
  <p>Django model and form validation is a somewhat complicated and 
confusing topic in Django app development.  A developer needs to understand 
several basic concepts such as model, model field, form, model form, etc. to 
have a good understanding of validation.  Most Django books and online tutorials 
do not have a good discussion on&nbsp;validation. </p>
<p>Django official documentation has detailed descriptions on validation. 
However, the contents are dispersed on several places.  This post describes the 
materials I have read on this&nbsp;topic. </p>
<h3>Validator&nbsp;Function</h3>
<p>The 
<a href="https://docs.djangoproject.com/en/2.2/ref/validators/#django.core.validators.EmailValidator">validator official documentation page</a> 
is a good starting point to study model and form&nbsp;validation. </p>
<p>The validator function is a callable that takes a value and raises a 
ValidationError if not validated. Here is an example from the&nbsp;page:</p>
<div class="highlight"><pre><span></span><code>from django.core.exceptions import ValidationError
from django.utils.translation import gettext_lazy as _

def validate_even(value):
    if value % 2 != 0:
        raise ValidationError(
            _(&#39;%(value)s is not an even number&#39;),
            params={&#39;value&#39;: value},
        )

from django.db import models

class MyModel(models.Model):
    even_field = models.IntegerField(validators=[validate_even])
</code></pre></div>


<p>The subsection <em>how validators are run</em> on the validator
page has three&nbsp;links. </p>
<ul>
<li>The second link <em>validating objects</em> is about 
<em>model validation</em>.  The link points to a subsection on the 
<a href="https://docs.djangoproject.com/en/2.2/ref/models/instances/#validating-objects">model instance reference</a>&nbsp;page. </li>
<li>The first link <em>form validation</em> points 
to a separate page about 
<a href="https://docs.djangoproject.com/en/2.2/ref/forms/validation/"><em>form validation</em></a>. </li>
<li>The third link goes to the ModelForm&nbsp;page. </li>
</ul>
<h3>Model&nbsp;Validation</h3>
<p>A model&#8217;s <code>full_clean()</code> method performs model validation. The method calls 
three other&nbsp;methods:</p>
<ul>
<li><code>clean_fields()</code> method</li>
<li><code>clean()</code> method, as a&nbsp;whole</li>
<li><code>validate_unique()</code> method</li>
</ul>
<p>The model <code>save()</code> method does <span class="caps">NOT</span> call <code>full_clean()</code> method automatically. 
A programmer needs to call it manually to trigger model validation like 
the below&nbsp;code.</p>
<div class="highlight"><pre><span></span><code>try:
    article.full_clean()
except ValidationError as e:
    ...
    # handle the error
</code></pre></div>


<p><a href="https://stackoverflow.com/questions/7366363/adding-custom-django-model-validation">A stack overflow answer</a> 
shows a typical pattern to conduct custom model validation. The model class overrides the 
<code>clean()</code> method to provide custom model validation and the <code>save()</code> method 
to call <code>full_clean</code> method.  The example code is shown&nbsp;below:</p>
<div class="highlight"><pre><span></span><code>class BaseModel(models.Model):
    # model fields 

    def clean(self, *args, **kwargs):
        # add custom validation here
        super(BaseModel, self).clean(*args, **kwargs)

    def save(self, *args, **kwargs):
        self.full_clean()
        super(BaseModel, self).save(*args, **kwargs)
</code></pre></div>


<p><a href="https://stackoverflow.com/questions/42003866/django-validation-at-model-not-forms-level">Another stack overflow answer</a> 
shows how to use custom model validation or simply use model field&#8217;s built-in&nbsp;validator.</p>
<p>Model field&#8217;s validation will not kick in unless the <code>full_clean()</code> method 
is explicitly called. For example, the <code>p2.save()</code> below would not raise an 
exception when&nbsp;called. </p>
<div class="highlight"><pre><span></span><code>class PageModel(models.Model):
    name = models.CharField(max_length=50)
    slug = models.SlugField(max_length=50)

&gt;&gt;&gt; from page.models import PageModel #page app name
&gt;&gt;&gt; p1 = PageModel(name=&#39;Page1&#39;, slug=&#39;page1&#39;)
&gt;&gt;&gt; p1.save()
&gt;&gt;&gt; p2 = PageModel(name=&#39;Page2&#39;, slug=&#39;page2#$%&#39;)
&gt;&gt;&gt; p2.save()        # no error
&gt;&gt;&gt; p2.full_clean()  # raise exception
</code></pre></div>


<p>Checking <code>clean_fields()</code> method source code, it has the following lines. 
The <code>f.clean(...)</code> method calls validation method on a model&nbsp;field.</p>
<div class="highlight"><pre><span></span><code>try:
    setattr(self, f.attname, f.clean(raw_value, self))
except ValidationError as e:
    errors[f.name] = e.error_list
</code></pre></div>


<h3>Form&nbsp;Validation</h3>
<p>While model validation is a subsection on a Django documentation page, the 
<a href="https://docs.djangoproject.com/en/2.2/ref/forms/validation/">form validation</a> 
is on a separate page. Form validation is normally executed when the <code>is_valid()</code> 
method is called on a form. A programmer can also trigger form validation 
by accessing <code>errors</code> attribute or call <code>full_clean()</code> method of a&nbsp;form.</p>
<p>Form validation has a series of&nbsp;steps:</p>
<ul>
<li><code>to_python()</code> method on a field, correct data&nbsp;type</li>
<li><code>validation()</code> method on a&nbsp;field</li>
<li><code>run_validators()</code> method on a&nbsp;field</li>
<li><code>clean()</code> method on a Field subclass, which calls above three methods and returns the clean&nbsp;data</li>
<li><code>clean_&lt;fieldname&gt;()</code> method has access to cleaned_data Python object and returns value that replaces data in&nbsp;cleaned_data</li>
<li><code>clean()</code> method of form, for multiple&nbsp;fields</li>
</ul>
<p>The same documetation page has several nice examples, which are based on the 
model shown&nbsp;below:</p>
<div class="highlight"><pre><span></span><code>class ContactForm(forms.Form):
    subject = forms.CharField(max_length=100)
    message = forms.CharField()
    sender = forms.EmailField()
    recipients = MultiEmailField()
    cc_myself = forms.BooleanField(required=False)
</code></pre></div>


<p>The same page points out that &#8220;there are special considerations when overriding 
the <code>clean()</code> method of a ModelForm&nbsp;subclass.&#8221;</p>
<p>Chapter 7 of Andrew Pinkham&#8217;s <em>Django Unleashed</em> book, titled <em>allowing user 
input with forms</em>, has good example on how to override <code>clean_&lt;fieldname&gt;</code> 
method. The discussion on model validation and form validation in this chapter 
is better than other Django books I have&nbsp;read. </p>
<h3>ModelForm&nbsp;Validation</h3>
<p>The form validation steps described in the previous section also apply to 
ModelForm validation.  In addition to that, <code>Model.full_clean()</code> method is 
triggered after the form&#8217;s <code>clean()</code> method is called. So, model validation 
methods are not triggered by model <code>save()</code> method, but model validation methods 
are triggered by ModelForm validation. 
<a href="https://stackoverflow.com/questions/40881708/django-model-validator-not-working-on-create">This stack overflow question</a> 
discusses this exact issue. The accepted answer also has code example on 
model&nbsp;validation. </p>
<p>Error messages at the form field level take precedence over the error messages 
defined at the model field&nbsp;level. </p>

    </div>
  </div>

</div>
  
   

    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>

  </body>
</html>